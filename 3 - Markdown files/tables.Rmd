---
output:
  pdf_document:
    keep_tex: true
    fig_caption: yes
header-includes: 
  - \usepackage[USenglish]{babel}
  - \usepackage{fancyhdr}
  - \pagestyle{fancy}
  - \renewcommand{\sectionmark}[1]{\markright{#1}}
  - \fancyhf{}
  - \lhead{{}}
  - \rhead{{\today}} 
  - \cfoot{{\thepage}}
  - \usepackage[T1]{fontenc}
  - \usepackage{bm}
  - \usepackage{mathpazo}
  - \usepackage{tabularx}
  - \usepackage{titlesec}
  - \usepackage{graphicx, xcolor}
  - \usepackage{wrapfig}
  - \usepackage{amssymb}
  - \usepackage{amsmath}
  - \usepackage{lscape}
  - \usepackage{esint}
  - \usepackage{paralist}
  - \usepackage{outlines}
  - \newcommand{\I}{\textrm{I}}
  - \newcommand{\N}{\mathcal{N}}
  - \newcommand{\D}{\textrm{D}}
  - \newcommand{\E}{\mathbb{E}}
  - \setlength{\parskip}{1em} %0.5\baselineskip
  - \setlength{\parindent}{0pt}
  - \linespread{1.15}
  - \titleformat*{\section}{\Large\scshape\bfseries}
  - \titleformat*{\subsection}{\large\scshape\bfseries}
  - \titleformat*{\subsubsection}{\bfseries}
  - \titleformat*{\paragraph}{\bfseries}
  - \titleformat*{\subparagraph}{\bfseries}
  - \renewcommand{\thesection}{\Roman{section}.} % 1.A. as subsections
  - \renewcommand{\thesubsection}{\Alph{subsection}.} % 1.A. as subsections
  - \titlespacing{\section}{0pt}{2pt}{3pt}
  - \titlespacing{\subsection}{0pt}{2pt}{2pt}
  - \titlespacing{\subsubsection}{0pt}{0pt}{0pt}
  - \titlespacing{\paragraph}{0pt}{1pt}{5pt}
  - \titlespacing{\subparagraph}{10pt}{1pt}{5pt}
  - \usepackage{hyperref}
  - \usepackage[font={footnotesize}]{subcaption}
  - \usepackage[font={footnotesize}]{caption}
  - \usepackage{caption, setspace}
  - \captionsetup{font={stretch=1}}
  - \captionsetup[figure]{font=footnotesize,labelfont=footnotesize}
  - \usepackage{tabto}
  - \def\quoteattr#1#2{\setbox0=\hbox{#2}#1\tabto{\dimexpr\linewidth-\wd0}\box0}
  - \makeatletter
  - \newcommand{\pushright}[1]{\ifmeasuring@#1\hfill$\displaystyle#1$\fi\ignorespaces}
  - \makeatother
  - \newcommand{\FixMe}[1]{\textcolor{orange}{ [#1]}}
  - \newcommand{\Comment}[1]{\textcolor{purple}{\textit{[#1]}}}
  - \newcommand{\Quickwin}{{\color{blue}{$\bigstar$}} }
  - \usepackage{letltxmacro}
  - \LetLtxMacro\Oldfootnote\footnote
  - \newcommand{\EnableFootNotes}{\LetLtxMacro\footnote\Oldfootnote}
  - \newcommand{\DisableFootNotes}{\renewcommand{\footnote}[2][]{\relax}}
  - \makeatother
  - \graphicspath{{../Output/"}}

---

\begin{center} 
    \textbf{\scshape \LARGE Tables}\\  \vspace{2mm}
    {\large COVID-19 and Excess All-Cause Mortality in the US and 18 Comparison Countries}\\ \vspace{2mm} 
    {\large A Cross-Country Comparison}\\ \vspace{2mm}
    {\large Alyssa Bilinski\footnote{Contact: abilinski@g.harvard.edu} $\cdot$ Ezekiel Emanuel} \\
\end{center}
    
\vspace{-0.50em}

\bigskip

This Markdown document generates Tables 1 and 2 
```{r}

#### SOURCE GLOBAL OPTIONS ####
# set working directory
setwd("~/Dropbox/Excess deaths/Public code/")

# source global options
source("global_options.R")

#### Choose countries ####

oecd = unlist(read.csv("oecd_countries.csv") %>% right_join(gdp, "Country") %>% dplyr::select(Country.formatted))
urbn = read.csv("urbn_pop.csv") %>% mutate(urbn_2019 = X2019..YR2019.) %>% dplyr::select(Country.Code, urbn_2019)
wb = read.csv("wb_per_capita_GDP.csv") %>% mutate(gdp_2019 = X2019) %>% dplyr::select(Country.Code, gdp_2019)


#### ECDC data ####
e_cases = ecdc %>% group_by(location_name, subset, population_2019) %>%
  filter(subset == "confirmed") %>%
  summarize(
    date_first = min(date[count>0]),
    date_min = min(date[count>5]),
    date_start_major = min(date[count/population_2019>=1/1000000]),
    date_start_major_threshold = date_start_major + 60)

e = ecdc %>% filter(subset=='deaths') %>% group_by(location_name) %>%
  mutate(
    count_orig = count,
    count = ifelse(location_name=="Spain" & date>=as.Date("2020-05-22") & date<=as.Date("2020-06-18"), count[date=="2020-06-19"], count),
         rate_per_100k = 1e5*count/population_2019) %>% ungroup() %>%
  group_by(location_name) %>% mutate(chg = c(NA, diff(rate_per_100k)),
                                     roll7 = zoo::rollmean(chg, k = 7, fill = NA),
                                     chg_raw = c(NA, diff(count)),
                                     roll7_raw = zoo::rollmean(chg_raw, k = 7, fill = NA),
                                     date5 = min(date[(count/population_2019)>1/10000000]),
                                     date_min_deaths = min(date[count>0]))  %>% 
  left_join(e_cases, "location_name")

e1 = e %>% filter(location_name%in%oecd) %>% filter(population_2019>5e6) %>% left_join(wb, c("iso3c" = "Country.Code")) %>% filter(gdp_2019 > 25000)#%>% filter(urbn_2019 >= 75 & urbn_2019 <= 95)

e2 = e1 %>%
    #filter(location_name %in% countries) %>%
    mutate(country_lab = ifelse(date=="2020-09-01", iso2c, NA),
           country_lab_roll = ifelse(date=="2020-09-01", iso2c, NA),
           col = ifelse(location_name=="United_States_of_America", "US", "Optimal"),
           col = ifelse(location_name%in%c("Italy", "France", "Sweden", "Spain", "United_Kingdom"), "Delayed", col),
           col = ifelse(location_name%in%c("Denmark", "Canada", "Finland", "Germany"), "Intermediate", col),
           pos1 = ifelse(location_name=="United_Kingdom", rate_per_100k + 1, rate_per_100k),
           pos1 = ifelse(location_name=="Spain", rate_per_100k - 1, pos1),
           pos1 = ifelse(location_name=="Germany", rate_per_100k + 1, pos1),
           pos1 = ifelse(location_name=="Denmark", rate_per_100k - 1, pos1),
           pos1 = ifelse(location_name=="South_Korea", rate_per_100k + 1, pos1),
           pos2 = ifelse(location_name=="France", roll7_raw + 1, roll7_raw),
           pos2 = ifelse(location_name=="Australia", roll7_raw - 1, pos2),
           pos3 = ifelse(location_name=="Finland", count + 40, count),
           pos3 = ifelse(location_name=="South_Korea", count - 40, pos3),
           pos3 = ifelse(location_name=="Denmark", count + 80, pos3),
           pos3 = ifelse(location_name=="Australia", count - 80, pos3),
           pos3 = ifelse(location_name=="Germany", count + 1000, pos3),
           pos3 = ifelse(location_name=="Canada", count - 1000, pos3),
           pos3 = ifelse(location_name=="Spain", count - 2000, pos3))

```


```{r}

US_pop = e2$population_2019[e2$location_name=="United_States_of_America"][1]
US_5 = e2$count[e2$location_name=="United_States_of_America" & e2$date==e2$date5+60]
US_major = e2$count[e2$location_name=="United_States_of_America" & e2$date==e2$date_start_major_threshold-1]
US_May = e2$count[e2$location_name=="United_States_of_America" & e2$date==as.Date("2020-05-10")-1]
US_June = e2$count[e2$location_name=="United_States_of_America" & e2$date==as.Date("2020-06-07")-1]
max = e2$count[e2$location_name=="United_States_of_America" & e2$date==as.Date("2020-09-19")]

end_date = as.Date("2020-09-19")
e3 = e2 %>% mutate(location_name = gsub("_", " ", location_name)) %>%
  dplyr::group_by(location_name) %>% 
  dplyr::mutate(
    count_total = count[date==end_date],
    count_post_May = count[date==end_date] - count[date==(as.Date("2020-05-10")-1)],
      count_post_June = count[date==end_date] - count[date==(as.Date("2020-06-07")-1)],
    per100K_total = rate_per_100k[date==end_date],
                per100K_post_May = rate_per_100k[date==end_date] - rate_per_100k[date==(as.Date("2020-05-10")-1)],
                per100K_post_June = rate_per_100k[date==end_date] - rate_per_100k[date==(as.Date("2020-06-07")-1)],
    per100K_post_major = rate_per_100k[date==end_date] - rate_per_100k[date==(date_start_major_threshold-1)]) %>% filter(date==end_date) %>%
  group_by(location_name, date_start_major, population_2019, count_total, count_post_May, count_post_June, per100K_total, per100K_post_May, per100K_post_June, per100K_post_major) %>%
  dplyr::summarize(lives_saved_total = max - per100K_total/100000*US_pop,
                   lives_saved_since_May = max - (US_May +  per100K_post_May/100000*US_pop),
                   lives_saved_since_June = max - (US_June +  per100K_post_June/100000*US_pop),
                   lives_saved_since_major = max - (US_major +  per100K_post_major/100000*US_pop)) %>% #filter(location_name!="United States of America") %>% 
  #arrange(-lives_saved_total) %>% 
  ungroup() 

e3 = e3 %>% mutate(location_name = factor(location_name, levels = rev(unique(e3$location_name))))
summary(glm(formula = count_total~location_name, offset = log(population_2019), data = e3, family = poisson()))
summary(glm(formula = count_post_May~location_name, offset = log(population_2019), data = e3, family = poisson()))
summary(glm(formula = count_post_June~location_name, offset = log(population_2019), data = e3, family = poisson()))
#e2 %>% filter(date==as.Date("2020-09-01")) %>% filter(location_name=="United_States_of_America")

e4 = e3 %>% dplyr::select(1, c(7,8,10,11,12,14))
names(e4) = c("Country", "Deaths/100K",  "Deaths/100K (since 5/1)", "Deaths/100K (since major)","Difference in deaths", "Difference in deaths (since 5/1)", "Difference in deaths (since major)")

e4 = e4 %>% gather(var, value, 5,6,7) %>% mutate(value = paste(comma(round(value)), " (", round(value/max*100), "%)", sep = "")) %>% spread(var, value) %>% arrange(`Deaths/100K`)

write.csv(e4, file = "COVID_deaths_tables_FINv1.csv")

e4 = e3 %>% dplyr::select(1, c(2,7,8,9,11,12,13))
names(e4) = c("Country", "Date", "Deaths/100K",  "Deaths/100K (since 5/1)", "Deaths/100K (since 6/1)","Difference in deaths", "Difference in deaths (since 5/1)", "Difference in deaths (since 6/1)")

e4 = e4 %>% gather(var, value, 6:8) %>% mutate(value = paste(comma(round(value)), " (", round(value/max*100), ")", sep = "")) %>% spread(var, value) %>% arrange(`Deaths/100K`)

write.csv(e4, file = "COVID_deaths_tables_FINv2.csv")

                                              
```

```{r sens}



sens_crit = function(e2 = e2, k){
  
    e2 = e2 %>% group_by(location_name) %>% 
      mutate(date_crit = min(date[count > k] + 60)) %>%
      ungroup() 

    US_crit = e2$count[e2$location_name=="United_States_of_America" & e2$date==e2$date_crit]

    e3 = e2 %>% mutate(location_name = gsub("_", " ", location_name)) %>%
    dplyr::group_by(location_name) %>% 
    dplyr::mutate(
      country_lab = iso2c[1],
      per100K_post_date = rate_per_100k[date==as.Date("2020-09-01")] - rate_per_100k[date==(date_crit-1)]) %>% filter(date=="2020-09-01") %>%
    group_by(location_name, country_lab, per100K_post_date) %>%
    dplyr::summarize(lives_saved =  max - (US_crit +  per100K_post_date/100000*US_pop))
    
  return(e3)
}

sens_crit_threshold = function(e2 = e2, k){
  
    e2 = e2 %>% group_by(location_name) %>% 
      mutate(date_crit = min(date[count/population_2019 > k] + 60)) %>%
      ungroup() 

    US_crit = e2$count[e2$location_name=="United_States_of_America" & e2$date==e2$date_crit]

    e3 = e2 %>% mutate(location_name = gsub("_", " ", location_name)) %>%
    dplyr::group_by(location_name) %>% 
    dplyr::mutate(
      country_lab = iso2c[1],
      per100K_post_date = rate_per_100k[date==as.Date("2020-09-01")] - rate_per_100k[date==(date_crit-1)]) %>% filter(date=="2020-09-01") %>%
    group_by(location_name, country_lab, per100K_post_date) %>%
    dplyr::summarize(lives_saved =  max - (US_crit +  per100K_post_date/100000*US_pop))
    
  return(e3)
}
#### BY DATE ####
# Note if replicating with an earlier date range:
# Finland has no date reported March 3,6,8, and 11, but also had no deaths on these days
e2 = e2 %>% bind_rows(data.frame(location_name = "Finland", date = c(as.Date("2020-03-03"), as.Date("2020-03-05"), as.Date("2020-03-08"), as.Date("2020-03-11")), 
                                 rate_per_100k = 0))

start_date = as.Date("2020-03-10")
dates = seq(from = start_date, to = as.Date("2020-09-01"), by = 1)
sens_date_out = data.frame()
for(i in 1:length(dates)){
  temp = sens_date(e2, date_val = dates[i]) %>% mutate(date = dates[i])
  sens_date_out = sens_date_out %>% bind_rows(temp)
}


sens_date_post = sens_date_out %>% filter(location_name!="United States of America") %>%
  mutate(col = ifelse(location_name=="United_States_of_America", "US", "Optimal"),
           col = ifelse(location_name%in%c("Italy", "France", "Sweden", "Spain", "United Kingdom"), "Delayed", col),
           col = ifelse(location_name%in%c("Denmark", "Canada", "Finland", "Germany"), "Intermediate", col),
           pos1 = ifelse(location_name=="Singapore", lives_saved + 1500, lives_saved),
           pos1 = ifelse(location_name=="South Korea", lives_saved - 1500, pos1),
           pos1 = ifelse(location_name=="Denmark", lives_saved + 1500, pos1),
           pos1 = ifelse(location_name=="Germany", lives_saved - 1500, pos1),
           pos1 = ifelse(location_name=="Spain", lives_saved + 1500, pos1),
           pos1 = ifelse(location_name=="United Kingdom", lives_saved - 1500, pos1),
           pos1 = ifelse(location_name=="Italy", lives_saved + 1500, pos1),
           pos1 = ifelse(location_name=="Sweden", lives_saved - 1500, pos1))

a_sens = ggplot(sens_date_post, aes(x = date, y = lives_saved, group = location_name, col = col)) + geom_line() + theme_opts + scale_color_manual(guide = F, values = pal) + 
  scale_x_date(expand = c(0,10), date_breaks = "1 month", date_labels = "%b") + 
  scale_y_continuous(labels = comma, expand = c(0,10), lim = c(-25000,200000),
                     sec.axis = sec_axis(~.*100/max, name = "Percentage of total US deaths (%)")) +
  geom_point(x = start_date, col = "white", size = 7) + 
  geom_text(size = 3, x = start_date, aes(y = pos1, label = ifelse(date=="2020-03-15", country_lab, ""))) + 
  labs(x = "Start date", y = "US death difference", title = "Sensitivity analysis (start date)") 

#### BY DEATHS PER CAPITA ####
deaths_val = seq(from = .5/10000000, to = 3/10000000, length.out = 20)
sens_deaths_out = data.frame()
for(i in 1:length(deaths_val)){
  temp = sens_crit_threshold(e2, k = deaths_val[i]) %>% mutate(deaths_val = deaths_val[i])
  sens_deaths_out = sens_deaths_out %>% bind_rows(temp)
}

sens_deaths_out = sens_deaths_out %>% filter(location_name!="United States of America") %>%
  mutate(col = ifelse(location_name=="United_States_of_America", "US", "Optimal"),
           col = ifelse(location_name%in%c("Italy", "France", "Sweden", "Spain", "United Kingdom"), "Delayed", col),
           col = ifelse(location_name%in%c("Denmark", "Canada", "Finland", "Germany"), "Intermediate", col),
           pos3 = ifelse(location_name=="Singapore", lives_saved + 2000, lives_saved),
           pos3 = ifelse(location_name=="Germany", lives_saved - 2000, pos3))

b_sens = ggplot(sens_deaths_out, aes(x = deaths_val*100000, y = lives_saved, group = location_name, col = col)) + geom_line() + theme_opts + scale_color_manual(guide = F, values = pal) + 
  scale_y_continuous(labels = comma,
                     sec.axis = sec_axis(~.*100/max, name = "Percentage of total US deaths (%)")) +
  geom_point(x = min(deaths_val)*100000, col = "white", size = 6) + 
  geom_text(size = 3, x = min(deaths_val)*100000, aes(y = pos3, label = ifelse(deaths_val==min(deaths_val), country_lab, ""))) + 
  labs(x = "Death threshold per 100K", y = "US death difference", title = "Sensitivity analysis (after death per capita threshold)") 


#### BY DEATHS ####
deaths_val = seq(from = 1, to = 25, by = 1)
sens_deaths_out = data.frame()
for(i in 1:length(deaths_val)){
  temp = sens_crit(e2, k = deaths_val[i]) %>% mutate(deaths_val = deaths_val[i])
  sens_deaths_out = sens_deaths_out %>% bind_rows(temp)
}

sens_deaths_out = sens_deaths_out %>% filter(location_name!="United States of America") %>%
  mutate(col = ifelse(location_name=="United_States_of_America", "US", "Optimal"),
           col = ifelse(location_name%in%c("Italy", "France", "Sweden", "Spain", "United Kingdom"), "Delayed", col),
           col = ifelse(location_name%in%c("Denmark", "Canada", "Finland", "Germany"), "Intermediate", col),
           pos2 = ifelse(location_name=="Singapore", lives_saved + 2000, lives_saved),
           pos2 = ifelse(location_name=="Germany", lives_saved - 2000, pos2))

c_sens = ggplot(sens_deaths_out, aes(x = deaths_val, y = lives_saved, group = location_name, col = col)) + geom_line() + theme_opts + scale_color_manual(guide = F, values = pal) + 
  scale_y_continuous(labels = comma, expand = c(0,10), lim = c(40000,125000),
                     sec.axis = sec_axis(~.*100/max, name = "Percentage of total US deaths (%)")) +
  geom_point(x = 1, col = "white", size = 5) + 
  geom_text(size = 3, x = 1, aes(y = pos2, label = ifelse(deaths_val==1, country_lab, ""))) + 
  labs(x = "Deaths threshold", y = "US death difference", title = "Sensitivity analysis (after death threshold)") 

```

```{r}

setwd("~/Dropbox/Excess deaths/Data/Excess deaths")

start_week = 9
# USA
usa = read.csv("USA.csv") %>% group_by(Type, Week, Time.Period, Jurisdiction) %>% summarize(deaths = sum(Number.of.Deaths, na.rm = T), deaths_NA = sum(is.na(Number.of.Deaths))) %>%
  mutate(deaths = ifelse(Time.Period==2020, deaths, deaths/5)) 

```

\bigskip

## Calculations

We specify calculations used to generate Tables 1 and 2.

\bigskip

### Potential difference in deaths during the reporting period
Let $r_i$ be the death rate of interest (reported COVID-19 deaths or excess mortality) per 100,000 in country $i$, and $d$ be US deaths over the full reporting period.  Let $p$ be the US 2019 population, $p=329,064,917$ per European Centre for Disease Prevention and Control data.  We estimate potential difference in deaths averted:
\begin{align*}
d - \left(r_i/100,000\right)*p
\end{align*}

### Potential difference in deaths if matching after a given date
Letting $r_{iT}$ be the death rate per 100,000 in country $i$ between time $T$ and the end of the reporting period and $d_T$ be US deaths by time $T$, we estimate potential difference in deaths since time $T$:
\begin{align*}
d - \left(d_T + \left(r_{iT}/100,000\right)*p\right)
\end{align*}

### Potential difference if matching after some criteria is met
Let time $T_i$ be the time that country $i$ meets some criteria (e.g. 2 months after first 5 deaths, or after 0.1 deaths per million population).  Let $T$ be the time that the US meets the criteria.  Letting $r_{iT_i}$ be the death rate per 100,000 in a comparison country between time $T_1$ and the end of the reporting period and $d_{T_2}$ be US deaths by time $T$, we estimate potential difference in deaths since time $T$:
\begin{align*}
d - \left(d_{T} + \left(r_{iT_i}/100,000\right)*p\right)
\end{align*}


## Data sources
We used several data sources for this work:

-  \textbf{European Centre for Disease Prevention and Control COVID-19 database}: (\href{https://www.ecdc.europa.eu/en/publications-data/download-todays-data-geographic-distribution-covid-19-cases-worldwide}{link}, accessed through R library \href{https://github.com/seandavi/sars2pack}{sars2pack})
- \textbf{Denmark:} Statistics Denmark (\href{https://www.statbank.dk/dodc2}{link})
- \textbf{Germany:} Federal Statistics Office (\href{https://www.destatis.de/EN/Themes/Society-Environment/Population/Deaths-Life-Expectancy/_node.html;jsessionid=91286BFEECCABAD3052B72D2C2760F99.internet8732}{link})
- \textbf{Finland:} Statistics Finland (\href{https://pxnet2.stat.fi/PXWeb/pxweb/en/Kokeelliset_tilastot/Kokeelliset_tilastot__vamuu_koke/statfin_vamuu_pxt_12ng.px/}{link})
- \textbf{France:} INSEE (\href{https://www.insee.fr/fr/statistiques/4487988?sommaire=4487854}{link}), used The Economist GitHub to obtain historical deaths
- \textbf{Spain:} National Statistics Institute (\href{https://www.ine.es/en/}{link})
- \textbf{Sweden:} Statistics Sweden (\href{https://www.scb.se/en/About-us/news-and-press-releases/statistics-sweden-to-publish-preliminary-statistics-on-deaths-in-sweden/}{link})
- \textbf{UK:} Office of National Statistics (\href{https://www.ons.gov.uk/peoplepopulationandcommunity/birthsdeathsandmarriages/deaths/datasets/weeklyprovisionalfiguresondeathsregisteredinenglandandwales}{link}), National Records of Scotland (\href{https://www.nrscotland.gov.uk/covid19stats}{link}), Northern Ireland Statistics and Research Agency (\href{https://www.nisra.gov.uk/publications/weekly-deaths}{link})
- \textbf{US:} CDC Excess Deaths Associated with COVID-19 (\href{https://www.cdc.gov/nchs/nvss/vsrr/covid19/excess_deaths.htm}{link})
- \textbf{Additional references}: \href{https://github.com/TheEconomist/covid-19-excess-deaths-tracker}{The Economist} and \href{https://github.com/nytimes/covid-19-data/tree/master/excess-deaths}{The New York Times} excess death GitHubs for sources and for France historical death data (\emph{Economist} version)

\bigskip

## Notes

1. There is debate in the epidemiological community regarding whether to adjust deaths per capita early in the pandemic.  Given a fixed number introductions, we do not expect that early in a pandemic, a virus would spread faster in a larger population than in a smaller one.  Nevertheless, we defer to per capita measures due to the geographic and demographic diversity of the United States that renders it likely more similar to a combination of small countries than a single countries, and as viral introductions may have been more proportional to population.
2. Spain adjusted its cumulative COVID-19 death toll downward (and then partially upward) during May and June 2020.  We smoothed this to be monotonic over this time period by setting cumulative deaths between May 23, 2020 and June 18, 2020 to be equal to the reported death toll on June 19, 2020 (Figure \ref{supp.fig.spain}).
3. For recent periods in which some deaths may not yet have been reported, the United States CDC provides estimates of both unweighted deaths and deaths weighted to attempt to adjust for underreporting.  To be conservative in our estimate of excess deaths, we use the latter, which  (Figure \ref{supp.fig.weighting}).
4. Several countries reported lower than average all-cause mortality prior to the pandemic, making all-cause mortality estimates sensitive to the start date used (Figure \ref{supp.weekly.deaths}).
 

```{r notes2, results = 'tex', fig = T, fig.pos = "H", fig.height = 2.5, fig.cap = "\\label{supp.fig.spain} Spanish COVID-19 deaths, with and without smoothing."}

b = ggplot(e2 %>% filter(location_name=="Spain") %>% gather(var, value, count, count_orig) %>%
             mutate(var2 = ifelse(var=="count_orig", "Original", "Smoothed")), 
           aes(x = date, y = value, lty = var2)) + geom_line() + theme(text = element_text(family = "sans"), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "darkgrey")) + 
  scale_color_manual(name = "", values = pal) + scale_linetype(name = "") + 
  scale_y_continuous(labels = comma) + labs(x = "Week", y= "Deaths", title = "Spain") 

b
```

```{r notes, results = 'tex', fig = T, fig.height = 2.5, fig.pos = "H", fig.cap = "\\label{supp.fig.weighting} Deaths by week with and without weighting for underreporting.  The line marked 2015-2019 represented the average over those years."}

a = ggplot(usa %>% filter(Jurisdiction=="United States") %>% filter(Week <= 30) %>% mutate(go = paste(Time.Period, Type)), aes(x = Week, y = deaths, group = go, col = Time.Period, lty = Type)) + geom_line() + 
  theme_opts + 
  scale_color_manual(name = "", values = pal) + scale_linetype(name = "") + 
  scale_y_continuous(labels = comma) + labs(x = "Week", y= "Deaths", title = "USA") 

a
```

\pagebreak

## Mortality Time Series

```{r percapitaplot, results = 'tex', fig.pos = "H", fig = T, fig.width = 11, fig.height = 11, fig.cap="Estimates of per capita and total mortality from February-September 2020."}

e2 = e2 %>% filter(date > as.Date("2020-02-20") & date <= "2020-09-24")

# rate per 100K

# cumulative
a1 = ggplot(e2, aes(x = date, y = rate_per_100k, group = location_name, col = col)) + 
  geom_line() + scale_color_manual(values = pal, guide = F) + 
  geom_point(aes(x = as.Date("2020-09-07"), y = (rate_per_100k)), col = "white", size = 5) +
  geom_text(size = 3, aes(x = as.Date("2020-09-07"), y = pos1, label = country_lab)) + labs(x = "", y = "", title = "Cumulative deaths per 100K population") + 
  scale_x_date(expand = c(0,10)) + scale_y_continuous(expand = c(0,0), lim = c(0, 63)) + geom_vline(xintercept = as.Date("2020-05-01"), lty = 2, col = "darkgrey") + geom_vline(xintercept = as.Date("2020-06-01"), lty = 2, col = "darkgrey") + theme_opts

# 7-day average
a2 = ggplot(e2, aes(x = date, y = roll7, group = location_name, col = col)) + 
  geom_line() + 
  geom_text(size = 3, aes(x = as.Date("2020-09-07"), 
                y = roll7,
                label = ifelse(location_name%in%c("United_States_of_America", "Spain", "Australia"), country_lab, ""))) + 
  scale_color_manual(guide = F, values = pal) + 
  scale_x_date(expand = c(0,10)) + 
  scale_y_continuous(labels = comma, expand = c(0,0)) +
  labs(x = "", y = "", title = "Rolling 7-day average of deaths per 100K population") + geom_vline(xintercept = as.Date("2020-05-01"), lty = 2, col = "darkgrey") + geom_vline(xintercept = as.Date("2020-06-01"), lty = 2, col = "darkgrey") + theme_opts


# total
b1 = ggplot(e2, aes(x = date, y = roll7_raw, group = location_name, col = col)) + 
  geom_line() + 
  geom_text(size = 3, aes(x = as.Date("2020-09-15"), 
                y = roll7_raw,
                label = ifelse(location_name%in%c("United_States_of_America", "Spain"), country_lab, ""))) + 
  scale_color_manual(guide = F, values = pal) + 
  scale_x_date(expand = c(0,10)) + 
  scale_y_continuous(labels = comma, expand = c(0,10)) +
  labs(x = "", y = "", title = "Rolling 7-day average of deaths") + geom_vline(xintercept = as.Date("2020-05-01"), lty = 2, col = "darkgrey") + geom_vline(xintercept = as.Date("2020-06-01"), lty = 2, col = "darkgrey") + theme_opts

b2 = ggplot(e2, aes(x = date, 
                   y = ifelse(roll7_raw==0, .01, roll7_raw), group = location_name, col = col)) + 
  geom_line() + 
  geom_text(size = 3, aes(x = as.Date("2020-09-07"), 
                y = ifelse(roll7_raw==0, .01, roll7_raw),
                label =  country_lab_roll)) + 
  scale_color_manual(guide = F, values = pal) + 
  scale_x_date(expand = c(0,10)) + 
  scale_y_continuous(labels=comma_format(accuracy = 1),
                     limits = c(.5, 3000), trans = "log10", expand = c(0,0)) +
  labs(x = "", y = "", title = "Rolling 7-day average of deaths (log scale)")  + geom_vline(xintercept = as.Date("2020-05-01"), lty = 2, col = "darkgrey") + geom_vline(xintercept = as.Date("2020-06-01"), lty = 2, col = "darkgrey") + theme_opts


b3 = ggplot(e2, aes(x = date, y = count, group = location_name, col = col)) + 
  geom_line() + 
    geom_point(aes(x = as.Date("2020-09-07"), y = (count)), col = "white", size = 5) +
  geom_text(size = 3, aes(x = as.Date("2020-09-07"), y = count, label = country_lab)) +
  scale_color_manual(guide = F, values = pal) + 
  scale_x_date(expand = c(0,10)) + 
  scale_y_continuous(labels = comma_format(), expand = c(0,10), lim = c(0,200000)) +
  labs(x = "", y = "", title = "Cumulative deaths")  + geom_vline(xintercept = as.Date("2020-05-01"), lty = 2, col = "darkgrey") + geom_vline(xintercept = as.Date("2020-06-01"), lty = 2, col = "darkgrey") + theme_opts

b4 = ggplot(e2, aes(x = date, y = count, group = location_name, col = col)) + 
  geom_line() + 
    geom_point(aes(x = as.Date("2020-09-07"), y = (count)), col = "white", size = 5) +
  geom_text(size = 3, aes(x = as.Date("2020-09-07"), y = pos3, label = country_lab)) +
  scale_color_manual(guide = F, values = pal) + 
  scale_x_date(expand = c(0,10)) + 
  scale_y_continuous(labels=comma_format(accuracy = 1),
                     limits = c(.5, 250000), trans = "log10", expand = c(0,0)) +
  labs(x = "", y = "", title = "Cumulative deaths (log scale)")  + geom_vline(xintercept = as.Date("2020-05-01"), lty = 2, col = "darkgrey") + geom_vline(xintercept = as.Date("2020-06-01"), lty = 2, col = "darkgrey") + theme_opts

multiplot(a1, b3, b4, a2, b1, b2, cols = 2)
```

\pagebreak
# Sensitivity analyses: COVID-19 deaths

These sensitivity analyses (Figure \ref{sens1}) evaluate how different thresholds impact our estimates of the change in US deaths if the US had its initial surge but later matched per capita mortality rates of other countries.  Here we vary the time at which the US changes to another country's mortality rate in terms of 1) a switch triggered by calendar time, 2) a switch occuring 2 months after some number of deaths per capita or 3) a switch occuring 2 months after some number of deaths.  Details on these calculations are provided above.

\bigskip

```{r, results = 'tex', fig = T, fig.pos = "H", fig.width = 9, fig.height = 8, fig.pos = "H", fig.cap = "\\label{sens1} Deaths averted if the US matched each country's death rate across (top) calendar time, (middle) 2 months after reaching a per capita death threshold, (bottom) 2 months after reaching a specified number of deaths.  The 2 month lag allows for approximately 1 month of policy response time."}

print(multiplot(a_sens,b_sens,c_sens, cols = 2))

```
\pagebreak

# Sensitivity analysis: all-cause mortality

These sensitivity analyses first evaluate how estimates vary when the $\emph{start}$ week of data is varied. Due to lower than average all-cause mortality in several European countries early in 2020, starting later in the pandemic results in higher estimates of excess mortality in these countries, and thus a smaller difference in US deaths.  Next, we consider the impact of the US switching to a European country's death rate at different times in the pandemic after its initial surge.

```{r, fig.width = 9, fig.height = 8, fig.cap = "\\label{supp.weekly.deaths} All-cause mortality by country by week and year.  In Germany, we used only years 2016-19 due data accessibility."}

setwd("~/Dropbox/Excess deaths/Data/Excess deaths")

start_week = 2

# USA
usa2 = usa %>% filter(Week>=start_week & Week <= 30) %>% 
  filter(Jurisdiction=="United States") %>% group_by(Time.Period, Week, Type) %>%
  summarize(deaths_all = sum(deaths), deaths_May = sum(deaths[Week>=19])) %>% group_by(Type) %>%
  filter(Type=="Unweighted") %>% ungroup() %>%
  mutate(location_name = "United_States_of_America",
         Time.Period = ifelse(Time.Period=="2020", "2020", "2015-19"),
)

# Denmark
denmark = read.csv("denmark_raw.csv") %>% 
  mutate(date = as.Date(Date_mod, format = "%m/%d/%y"),
         year = year(date),
         Week = epiweek(date),
         Time.Period = ifelse(year==2020, "2020", "2015-19"),
         deaths = ifelse(Time.Period=="2020", Deaths, Deaths/5)) %>%
  filter(Week>=start_week & Week<=30) %>%
  group_by(Time.Period, Week) %>%
  summarize(deaths_all = sum(deaths), deaths_May = sum(deaths[Week>=19])) %>%
  mutate(location_name = "Denmark")

# Finland
finland = read.csv("finland.csv") %>%
  mutate(year = as.numeric(substring(Week, 1, 4)),
         Week = as.numeric(substring(Week, 6, 7)),
         Time.Period = ifelse(year==2020, "2020", "2015-19"),
         deaths = ifelse(Time.Period=="2020", Deaths, Deaths/5)) %>%
  filter(Week>=start_week & Week<=30) %>%
  group_by(Time.Period, Week) %>%
  summarize(deaths_all = sum(deaths), deaths_May = sum(deaths[Week>=19])) %>%
  mutate(location_name = "Finland")

# Sweden
sweden = read.csv("sweden_raw.csv") %>% 
  gather(var, value, 3:8) %>%
  mutate(year = as.numeric(substring(var, 2,5)),
         date = as.Date(X, format = "%m/%d/%y"))
year(sweden$date) = sweden$year
sweden = sweden %>% mutate(Week = epiweek(date),
         Time.Period = ifelse(year==2020, "2020", "2015-19"),
         deaths = ifelse(Time.Period=="2020", value, value/5)) %>%
  filter(Week>=start_week & Week<=30) %>%
  group_by(Time.Period, Week) %>%
  summarize(deaths_all = sum(deaths), deaths_May = sum(deaths[Week>=19])) %>%
  mutate(location_name = "Sweden")

# Spain
spain = read.csv("spain_raw.csv") %>%
  mutate(year = as.numeric(substring(Week, 1, 4)),
         Week = as.numeric(substring(Week, 6, 7)),
         Time.Period = ifelse(year==2020, "2020", "2015-19"),
         deaths = ifelse(Time.Period=="2020", Deaths, Deaths/5)) %>%
  filter(Week>=start_week & Week<=30) %>%
  group_by(Time.Period, Week) %>%
  summarize(deaths_all = sum(deaths), deaths_May = sum(deaths[Week>=19])) %>%
  mutate(location_name = "Spain")

# France
france1 = france1 = read.csv("france_raw.csv") %>%
  mutate(date = as.Date(paste(X, 2020, sep = ""), format = "%m/%d/%y"),
         month = month(date),
         year = 2020,
         week = epiweek(date),
         Total_deces_2020 = c(NA, diff(Total_deces_2020))) %>% filter(week >=19 & week <= 30) %>%
  dplyr::group_by(year, week) %>%
  dplyr::summarize(total_deaths = sum(Total_deces_2020)) %>%
  dplyr::select(year, week, total_deaths) %>% filter(week!=19)

france = read.csv("france_national_weekly_deaths_AB.csv") %>%
  mutate(year = year(as.Date(start_date))) %>%
  bind_rows(france1) %>% filter(week >=start_week & week <= 30) %>%
  mutate(Week = week,
    Time.Period = ifelse(year=="2020", "2020", "2015-19"),
         deaths = ifelse(Time.Period=="2020", total_deaths, total_deaths/5)) %>%
  group_by(Time.Period, Week) %>%
  summarize(deaths_all = sum(deaths), deaths_May = sum(deaths[week>=19])) %>%
  mutate(location_name = "France")

# Germany
germany = read.csv("germany_raw.csv") %>% 
  mutate(date = as.Date(Date, format = "%m/%d/%y"),
         year = year(date),
         Week = epiweek(date),
         Time.Period = ifelse(year==2020, "2020", "2016-19"),
         deaths = ifelse(Time.Period=="2020", Deaths, Deaths/4)) %>%
  filter(Week>=start_week & Week<=30) %>%
  group_by(Time.Period, Week) %>%
  summarize(deaths_all = sum(deaths), deaths_May = sum(deaths[Week>=19])) %>%
  mutate(location_name = "Germany")

## UK
# England/Wales
gb = read.csv("gb_raw.csv")  %>% 
  mutate(date = as.Date(date, format = "%d-%b-%y"),
         year = year(date),
         Time.Period = ifelse(year==2020, "2020", "2015-19"),
         deaths = ifelse(Time.Period=="2020", deaths, deaths/5)) %>%
  filter(week>=start_week & week<=30) %>% mutate(Week = week) %>%
  group_by(Time.Period, Week) %>%
  summarize(deaths_all = sum(deaths), deaths_May = sum(deaths[week>=19])) 

# Northern Ireland
ni = read.csv("northern_ireland_raw.csv") %>%
  mutate(date = as.Date(date, format = "%m/%d/%y"),
         year = year(date),
         Time.Period = ifelse(year==2020, "2020", "2015-19"),
         deaths = ifelse(Time.Period=="2020", deaths, deaths/5)) %>%
  filter(week>=start_week & week<=30) %>% mutate(Week = week) %>%
  group_by(Time.Period, Week) %>%
  summarize(deaths_all = sum(deaths), deaths_May = sum(deaths[week>=19]))
  
# Scotland
scotland = read.csv("scotland.csv") %>% 
  gather(var, value, X2015, X2016, X2017, X2018, X2019, X2020) %>%
  mutate(year = as.numeric(substring(var, 2, 5)),
         week = as.numeric(substring(WeekNumber, 2, 3)),
         Time.Period = ifelse(year==2020, "2020", "2015-19"),
         deaths = ifelse(Time.Period=="2020", value, value/5)) %>%
  filter(week>=start_week & week<=30) %>% mutate(Week = week) %>%
  group_by(Time.Period, Week) %>%
  summarize(deaths_all = sum(deaths), deaths_May = sum(deaths[week>=19]))
 
uk = bind_rows(gb, ni, scotland) %>% group_by(Week, Time.Period) %>% summarize(deaths_all = sum(deaths_all), deaths_May = sum(deaths_May)) %>%
  mutate(location_name = "United_Kingdom")

deaths = bind_rows(france, spain, denmark, finland, sweden, uk, germany) %>% mutate(location_name = gsub("_", " ", location_name))

ggplot(deaths, aes(x = Week, y = deaths_all, group = Time.Period, col = Time.Period)) + geom_line() + facet_wrap(.~location_name, scales = "free") + theme_opts + scale_color_manual(values = pal) + labs(x = "Week", y="Deaths")
```

```{r, fig = T, fig.width = 10, fig.pos = "H", fig.height = 5, fig.cap = "\\label{supp.deaths} Sensitivity analyses for excess death data.  These sensitivity analyses first evaluate how estimates vary when the start week of data is varied and death difference is calculated through week 30 2020.  We then consider the impact of the US switching to a European country's death rate at different times in the pandemic after its initial surge, with the default in the paper used as week 19 (May 3)."}

setwd("~/Dropbox/Excess deaths/Data/Excess deaths")

sens_excess = function(start_week = 2, week_stop = 19){
  
usa2 = usa %>% filter(Week>=start_week & Week <= 30) %>% 
  filter(Jurisdiction=="United States") %>% group_by(Time.Period, Type) %>%
  summarize(deaths_all = sum(deaths), deaths_May = sum(deaths[Week>=week_stop])) %>% group_by(Type) %>%
  summarize(excess_all = diff(deaths_all), excess_May = diff(deaths_May)) %>%
  filter(Type=="Unweighted") %>% 
  mutate(location_name = "United_States_of_America")

# Denmark
denmark = read.csv("denmark_raw.csv") %>% 
  mutate(date = as.Date(Date_mod, format = "%m/%d/%y"),
         year = year(date),
         Week = epiweek(date),
         Time.Period = ifelse(year==2020, "2020", "2015-19"),
         deaths = ifelse(Time.Period=="2020", Deaths, Deaths/5)) %>%
  filter(Week>=start_week & Week<=30) %>%
  group_by(Time.Period) %>%
  summarize(deaths_all = sum(deaths), deaths_May = sum(deaths[Week>=week_stop])) %>%
  ungroup() %>% 
  summarize(excess_all = diff(deaths_all), excess_May = diff(deaths_May)) %>%
  mutate(location_name = "Denmark")

# Finland
finland = read.csv("finland.csv") %>%
  mutate(year = as.numeric(substring(Week, 1, 4)),
         Week = as.numeric(substring(Week, 6, 7)),
         Time.Period = ifelse(year==2020, "2020", "2015-19"),
         deaths = ifelse(Time.Period=="2020", Deaths, Deaths/5)) %>%
  filter(Week>=start_week & Week<=30) %>%
  group_by(Time.Period) %>%
  summarize(deaths_all = sum(deaths), deaths_May = sum(deaths[Week>=week_stop])) %>%
  ungroup() %>% 
  summarize(excess_all = diff(deaths_all), excess_May = diff(deaths_May)) %>%
  mutate(location_name = "Finland")

# Sweden
sweden = read.csv("sweden_raw.csv") %>% 
  gather(var, value, 3:8) %>%
  mutate(year = as.numeric(substring(var, 2,5)),
         date = as.Date(X, format = "%m/%d/%y"))
year(sweden$date) = sweden$year
sweden = sweden %>% mutate(Week = epiweek(date),
         Time.Period = ifelse(year==2020, "2020", "2015-19"),
         deaths = ifelse(Time.Period=="2020", value, value/5)) %>%
  filter(Week>=start_week & Week<=30) %>%
  group_by(Time.Period) %>%
  summarize(deaths_all = sum(deaths), deaths_May = sum(deaths[Week>=week_stop])) %>%
  ungroup() %>% 
  summarize(excess_all = diff(deaths_all), excess_May = diff(deaths_May)) %>%
  mutate(location_name = "Sweden")

# Spain
spain = read.csv("spain_raw.csv") %>%
  mutate(year = as.numeric(substring(Week, 1, 4)),
         Week = as.numeric(substring(Week, 6, 7)),
         Time.Period = ifelse(year==2020, "2020", "2015-19"),
         deaths = ifelse(Time.Period=="2020", Deaths, Deaths/5)) %>%
  filter(Week>=start_week & Week<=30) %>%
  group_by(Time.Period) %>%
  summarize(deaths_all = sum(deaths), deaths_May = sum(deaths[Week>=week_stop])) %>%
  ungroup() %>% 
  summarize(excess_all = diff(deaths_all), excess_May = diff(deaths_May)) %>%
  mutate(location_name = "Spain")

# France
france1 = france1 = read.csv("france_raw.csv") %>%
  mutate(date = as.Date(paste(X, 2020, sep = ""), format = "%m/%d/%y"),
         month = month(date),
         year = 2020,
         week = epiweek(date),
         Total_deces_2020 = c(NA, diff(Total_deces_2020))) %>% filter(week >=19 & week <= 30) %>%
  dplyr::group_by(year, week) %>%
  dplyr::summarize(total_deaths = sum(Total_deces_2020)) %>%
  dplyr::select(year, week, total_deaths) %>% filter(week!=19)

france = read.csv("france_national_weekly_deaths_AB.csv") %>%
  mutate(year = year(as.Date(start_date))) %>%
  bind_rows(france1) %>% filter(week >=start_week & week <= 30) %>%
  mutate(Time.Period = ifelse(year=="2020", "2020", "2015-19"),
         deaths = ifelse(Time.Period=="2020", total_deaths, total_deaths/5)) %>%
  group_by(Time.Period) %>%
  summarize(deaths_all = sum(deaths), deaths_May = sum(deaths[week>=week_stop])) %>%
  ungroup() %>% 
  summarize(excess_all = diff(deaths_all), excess_May = diff(deaths_May)) %>%
  mutate(location_name = "France")

# Italy
italy_pre = read.csv("italy_weekly_deaths_AB.csv") %>% mutate(
    Time.Period = ifelse(year==2020, "2020", "2015-19"),
         deaths = ifelse(Time.Period=="2020", total_deaths, total_deaths/5))

italy = italy_pre %>%
  filter(week>=start_week & week<=25) %>%
  group_by(Time.Period) %>%
  summarize(deaths_all = sum(deaths), deaths_May = sum(deaths[week>=week_stop])) %>%
  ungroup() %>% 
  summarize(excess_all = diff(deaths_all), excess_May = diff(deaths_May)) %>%
  mutate(location_name = "Italy")

# Germany
germany = read.csv("germany_raw.csv") %>% 
  mutate(date = as.Date(Date, format = "%m/%d/%y"),
         year = year(date),
         Week = epiweek(date),
         Time.Period = ifelse(year==2020, "2020", "2015-19"),
         deaths = ifelse(Time.Period=="2020", Deaths, Deaths/4)) %>%
  filter(Week>=start_week & Week<=30) %>%
  group_by(Time.Period) %>%
  summarize(deaths_all = sum(deaths), deaths_May = sum(deaths[Week>=week_stop])) %>%
  ungroup() %>%
  summarize(excess_all = diff(deaths_all), excess_May = diff(deaths_May)) %>%
  mutate(location_name = "Germany")

## UK
# England/Wales
gb = read.csv("gb_raw.csv")  %>% 
  mutate(date = as.Date(date, format = "%d-%b-%y"),
         year = year(date),
         Time.Period = ifelse(year==2020, "2020", "2015-19"),
         deaths = ifelse(Time.Period=="2020", deaths, deaths/5)) %>%
  filter(week>=start_week & week<=30) %>%
  group_by(Time.Period) %>%
  summarize(deaths_all = sum(deaths), deaths_May = sum(deaths[week>=week_stop])) %>%
  ungroup() %>%
  summarize(excess_all = diff(deaths_all), excess_May = diff(deaths_May))

# Northern Ireland
ni = read.csv("northern_ireland_raw.csv") %>%
  mutate(date = as.Date(date, format = "%m/%d/%y"),
         year = year(date),
         Time.Period = ifelse(year==2020, "2020", "2015-19"),
         deaths = ifelse(Time.Period=="2020", deaths, deaths/5)) %>%
  filter(week>=start_week & week<=30) %>%
  group_by(Time.Period) %>%
  summarize(deaths_all = sum(deaths), deaths_May = sum(deaths[week>=week_stop])) %>%
  ungroup() %>%
  summarize(excess_all = diff(deaths_all), excess_May = diff(deaths_May))

# Scotland
scotland = read.csv("scotland.csv") %>% 
  gather(var, value, X2015, X2016, X2017, X2018, X2019, X2020) %>%
  mutate(year = as.numeric(substring(var, 2, 5)),
         week = as.numeric(substring(WeekNumber, 2, 3)),
         Time.Period = ifelse(year==2020, "2020", "2015-19"),
         deaths = ifelse(Time.Period=="2020", value, value/5)) %>%
  filter(week>=start_week & week<=30) %>%
  group_by(Time.Period) %>%
  summarize(deaths_all = sum(deaths), deaths_May = sum(deaths[week>=week_stop])) %>%
  ungroup() %>%
  summarize(excess_all = diff(deaths_all), excess_May = diff(deaths_May))
  
uk = bind_rows(gb, ni, scotland) %>% summarize(excess_all = sum(excess_all), excess_May = sum(excess_May)) %>%
  mutate(location_name = "United_Kingdom")
  
max = sum(usa$deaths[usa$Time.Period=="2020" & usa$Jurisdiction=="United States" & usa$Type=="Unweighted" & usa$Week >= start_week & usa$Week<=30])-sum(usa$deaths[usa$Time.Period=="2015-2019" & usa$Jurisdiction=="United States" & usa$Type=="Unweighted" & usa$Week >= start_week & usa$Week<=30])
prov = sum(usa$deaths[usa$Time.Period=="2020" & usa$Jurisdiction=="United States" & usa$Type=="Unweighted" & usa$Week >= start_week & usa$Week < week_stop])-sum(usa$deaths[usa$Time.Period=="2015-2019" & usa$Jurisdiction=="United States" & usa$Type=="Unweighted" & usa$Week >= start_week & usa$Week < week_stop])
#print(max);print(prov)
excess_deaths = bind_rows(usa2, france, spain, denmark, finland, sweden, uk, germany) %>%
  left_join(e2, "location_name") %>% ungroup() %>%
  group_by(location_name) %>%
  dplyr::summarize(
    ed = excess_all[1],
    total = excess_all[1]/population_2019[1]*1e5,
                post_May = excess_May[1]/population_2019[1]*1e5,
    lives_saved_total = max - total*US_pop/1e5,
                   lives_saved_since_May = max - (prov + post_May*US_pop/1e5))

names(excess_deaths) = c("Country", "Excess deaths", "Excess deaths/100K", "Excess deaths/100K since May",
                "Difference in deaths", "Difference in deaths (since May)")

return(excess_deaths)
}

#### START WEEK ####
start_week = 4:12
week_sens = data.frame()
for(i in 1:length(start_week)){
  temp = sens_excess(start_week[i],19) %>% mutate(start_week=start_week[i])
  week_sens = week_sens %>% bind_rows(temp)
}
  
week_sens = week_sens %>%
  mutate(col = ifelse(Country=="United_States_of_America", "US", "Optimal"),
           col = ifelse(Country%in%c("Italy", "France", "Sweden", "Spain", "United_Kingdom"), "Delayed", col),
           col = ifelse(Country%in%c("Denmark", "Canada", "Finland", "Germany"), "Intermediate", col),
         lab = ifelse(Country=="United_States_of_America", "US", Country),
         lab = ifelse(Country=="United_Kingdom", "UK", Country))
         
max = 231000         
a = ggplot(week_sens %>% filter(Country!="United_States_of_America"), aes(x = start_week, y = `Difference in deaths`, group = Country, col = col)) + geom_line() + theme_opts + scale_color_manual(guide = F, values = pal) + labs(x = "First week of data included", y = "Difference in deaths", title = "US death difference over \n pandemic varying data start week") + scale_y_continuous(labels = comma, expand = c(0,10), lim = c(-150000,260000),
                     sec.axis = sec_axis(~.*100/max, name = "Percentage of total US deaths (%)")) +
  xlim(4, 12.2) + 
  geom_text(size = 3, x = 12, aes(y = `Difference in deaths`+5000, label = ifelse(start_week==12, lab, "")))
 
#### END WEEK ####
end_week = 16:24
week_sens = data.frame()
for(i in 1:length(end_week)){
  temp = sens_excess(9, end_week[i]) %>% mutate(end_week=end_week[i])
  week_sens = week_sens %>% bind_rows(temp)
}
  
week_sens = week_sens %>%
  mutate(col = ifelse(Country=="United_States_of_America", "US", "Optimal"),
           col = ifelse(Country%in%c("Italy", "France", "Sweden", "Spain", "United_Kingdom"), "Delayed", col),
           col = ifelse(Country%in%c("Denmark", "Canada", "Finland", "Germany"), "Intermediate", col),
         lab = ifelse(Country=="United_States_of_America", "US", Country),
         lab = ifelse(Country=="United_Kingdom", "UK", Country))
         
max = 231000         
b = ggplot(week_sens %>% filter(Country!="United_States_of_America"), aes(x = end_week, y = `Difference in deaths (since May)`, group = Country, col = col)) + geom_line() + theme_opts + scale_color_manual(guide = F, values = pal) + labs(x = "Week match begins", y = "Difference in deaths", title = "US deaths matching all-cause \n mortality at different weeks") + scale_y_continuous(labels = comma, expand = c(0,10), lim = c(-70000, 170000),
                     sec.axis = sec_axis(~.*100/max, name = "Percentage of total US deaths (%)")) +
  xlim(15, 24.2)+
  geom_text(size = 3, x = 16, aes(y = `Difference in deaths (since May)`, label = ifelse(end_week==16, lab, "")))
 
print(multiplot(a,b, cols = 2))
```


\clearpage

## Demographic characteristics

```{r supplement, results = 'tex', fig = T, fig.width = 9.5, fig.height = 9, fig.pos = "H", fig.cap="\\label{supp.fig.1}Percentage of the population over 65 (Sources: OECD, World Bank, CIA World Factbook)."}

# set working directory
setwd("~/Dropbox/Excess deaths/Data")

theme_opts = theme_opts + theme(title = element_text(size = 5))
# over 65
df = read.csv("prop_over_65_OECD.csv") %>% 
  # filter for year and outcome of interest
  filter(Measure == "% of total population" & VAR == "STRUSFPL") %>% 
  filter(Year==2019) %>% filter(Country %in% c("Australia", "Canada", "Demark",
                                               "Finland", "Germany", "Korea",
                                               "United States", "France", "Italy",
                                               "Spain", "United Kingdom", "Sweden")) %>%
  bind_rows(data.frame(Country = "Singapore", Value = 12.4))


a = ggplot(df, aes(x = reorder(Country, Value), y = Value)) + 
  geom_bar(stat = "identity", fill = "#457b9d") + 
  theme_minimal() + 
  scale_y_continuous(expand = c(0,0)) + 
  geom_text(size = 3, col = "white", aes(y = Value/2, label = round(Value))) + 
  labs(x = "", y = "", 
       title = "Percentage of population 65+ (2019)") + coord_flip() + 
  theme(text = element_text(family = "sans"), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "darkgrey"))

# urban
wb_spelling = c("Australia", "Canada", "Denmark",
                "Finland", "Germany", "Korea, Rep.",
                "United States", "France", "Italy",
                "Spain", "United Kingdom", "Sweden", "Singapore")
df = read.csv("urban_development.csv") %>% filter(Country.Name %in% wb_spelling) 

b = ggplot(df, aes(x = reorder(Country.Name, X2019), y = X2019)) + 
  geom_bar(stat = "identity", fill = "#457b9d") + 
  theme_minimal() + 
  scale_y_continuous(expand = c(0,0)) + 
  geom_text(size = 3, col = "white", aes(y = X2019/2, label = round(X2019))) + 
  labs(x = "", y = "", 
       title = "Percentage urban population (2019)") + coord_flip() + 
  theme(text = element_text(family = "sans"), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "darkgrey"))

# per cap GDP
df = read.csv("per_cap_GDP.csv") %>% filter(Country.Name %in% wb_spelling) 

c = ggplot(df, aes(x = reorder(Country.Name, X2019), y = X2019)) + 
  geom_bar(stat = "identity", fill = "#457b9d") + 
  theme_minimal() + 
  scale_y_continuous(expand = c(0,0)) + 
  geom_text(size = 3, col = "white", aes(y = X2019/2, label = comma(round(X2019)))) + 
  labs(x = "", y = "", 
       title = "Per capita GDP (ppp) (2019)") + coord_flip() + 
  theme(text = element_text(family = "sans"), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "darkgrey"))


# diabetes
df = read.csv("diabetes.csv") %>% filter(Country.Name %in% wb_spelling) 

d = ggplot(df, aes(x = reorder(Country.Name, X2019), y = X2019)) + 
  geom_bar(stat = "identity", fill = "#457b9d") + 
  theme_minimal() + 
  scale_y_continuous(expand = c(0,0)) + 
  geom_text(size = 3, col = "white", aes(y = X2019/2, label = round(X2019))) + 
  labs(x = "", y = "", 
       title = "Diabetes prevalence (ages 20-79) (2019)") + coord_flip() + 
  theme(text = element_text(family = "sans"), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "darkgrey"))

# OBESITY
df = read.csv("obesity.csv") %>% filter(Country %in% c("Australia", "Canada", "Denmark",
                "Finland", "Germany", "Korea, North",
                "United States", "France", "Italy",
                "Spain", "United Kingdom", "Sweden", "Singapore")) 

e = ggplot(df, aes(x = reorder(Country, Obese.2016), y = Obese.2016)) + 
  geom_bar(stat = "identity", fill = "#457b9d") + 
  theme_minimal() + 
  scale_y_continuous(expand = c(0,0)) + 
  geom_text(size = 3, col = "white", aes(y = Obese.2016/2, label = round(Obese.2016))) + 
  labs(x = "", y = "", 
       title = "Adult obesity prevalence (2016)") + coord_flip() + 
  theme(text = element_text(family = "sans"), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), 
        axis.line = element_line(colour = "darkgrey"))

multiplot(a,b,c, d,e,  cols = 2)

```
